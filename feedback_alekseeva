# wb_analyze_last_5_with_number.py
import requests
import pandas as pd
from datetime import datetime
import asyncio
import gspread
from google.oauth2.service_account import Credentials
from telegram import Bot
from collections import defaultdict

# === üîê –ù–ê–°–¢–†–û–ô–ö–ò ===
# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —É–±—Ä–∞–Ω—ã –ø—Ä–æ–±–µ–ª—ã –≤ –∫–æ–Ω—Ü–µ URL
FEEDBACK_API = "https://feedbacks-api.wildberries.ru/api/v1/feedbacks"
CARDS_API = "https://suppliers-api.wildberries.ru/content/v2/get/cards/list"

# ‚úÖ –¢–æ–∫–µ–Ω—ã
WILDBERRIES_FEEDBACK_TOKEN = "eyJhbGciOiJFUzI1NiIsImtpZCI6IjIwMjUwNTIwdjEiLCJ0eXAiOiJKV1QifQ.eyJlbnQiOjEsImV4cCI6MTc3MTUzNDgxOCwiaWQiOiIwMTk4Y2JkYi04NzIwLTdhZjMtOGU4ZS05ZTIyZjhmMjZkMjMiLCJpaWQiOjQxNTAzMjgwLCJvaWQiOjU2NzEzMSwicyI6MTI4LCJzaWQiOiI4YTNhYmRjMS0wMTdkLTQzMTgtOTI4MC0wNmU3OWRjNzllZmUiLCJ0IjpmYWxzZSwidWlkIjo0MTUwMzI4MH0.dxXdZp8WIuTAwLmcDa9YYog79jz-6iAWYajM0cP3Ul1-rQ82ZksWjp8Gx6JQhG8wlvn6JVJB9Ty45dpeaq0b_g"
WILDBERRIES_CARDS_TOKEN = "eyJhbGciOiJFUzI1NiIsImtpZCI6IjIwMjUwNTIwdjEiLCJ0eXAiOiJKV1QifQ.eyJlbnQiOjEsImV4cCI6MTc3MjA1MDQ3MSwiaWQiOiIwMTk4ZWE5Ny1jMjY0LTcxMjgtODU4MC0xOTdkNTJhYjIzYTgiLCJpaWQiOjE5ODUzNjk5LCJvaWQiOjI5MDk0NywicyI6MTA3Mzc0MTgyNiwic2lkIjoiNWZmZDIyZjgtMWYzMi00MjMyLTk4NTMtZDZmOTk5MWMwNDI1IiwidCI6ZmFsc2UsInVpZCI6MTk4NTM2OTl9.0qwunxjymXMVaCfcDcr0gOaPS70EMENHo52x9VvMnyEFtoNjRf5JYKlTdpd7YD2h2Ln7gDmlm-RLHVGbLxeiuA"

# Telegram
TELEGRAM_BOT_TOKEN = "8391873182:AAHUykid30Fssju6OfnUtwv6uCc9ZFdazho"
TELEGRAM_CHAT_ID = 935264202

# Google Sheets ‚Äî —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
SERVICE_ACCOUNT_INFO = {
    "type": "service_account",
    "project_id": "feedbacks-471412",
    "private_key_id": "57b989e9f10318c7577bad8184b429eca71b2545",
    "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDUp6q7XczzuQpX\nQzZXB29nom4NzRJ6EzKuyG9cZ45Lx8/tqSPHT6v09ygCprS9ZyBzL58J5cQgUz0c\nHMOB6yRKTRZ+oa+Q64HwVzcMYr3/xj0k1EsjRs2RDlkHijS1nSxkJSm6G+TDHEYB\nDqsFOj2pmKRzTUyJDBhsvZpOMzl+e/VaMrGMvc+qDELFL9sgAYnXbfdcKgoYQ/PV\nX+/SIaeWfrQfpCHDMYek8SC0hELnwuAG4w6yHN7FOAUF7iHOpQlgv+lZXdrtIyC6\nfvvpd9aKyuvVHpCxdIFyfOq1FxwdNxj3RDlKMP20A5PUdlRyCOvidAle/cCYthGU\nut/6ccs7AgMBAAECggEAPy5nqA6I97q5C08xZG8Vlu1oFFqjDDkK/GoZyBMOcI53\nxS1VL4EI3pnWPd9o4MM0nXR/JJIrEM2aYPFc1wtVd2vq7Im+X2jRbOaEuP3XZJhy\nDzCx+FOvfNMN+ZMC8Ri3GTP/b0edUqjiVasVfdKdgneTGJzVSfyZfylgIK7QfLbt\nkH/+e4msM7OPh5ejtgFyL9rQ3hNXwqtbnAAKirzdbeut8zWGQaXvuDQw9hPEiOeH\npxex+Ro4gRBzbcAaJ7aUJLe3ZftQ+cTPM2EOVOJ1byTRA6R5PSMuWIOFoXdFB+rr\n4kFC8v5C52YIdqRQbcIPkrM7+jobtPjTHKXpM4wueQKBgQD8MDzMrUHjZm4+dxpM\nNxG0MI2Rqx/KPezcMab+CYfCTLkhJ/znAbjNmSJU5rUw0WUOqxurTIsQFT2mPwGv\nRdK/IUbp1BbH4iqDjY8I81fO3zgYaQxvro2M5PM8p32BQZbPlOy69G+b1X+KlHvr\nbybo3bLAimQdl7Uh8viPO7OUIwKBgQDX3neer2AosqnaYDm1rFTt29+vMZKyDR0u\nTQ17WRRSflPAgvNTxeSmKlZYBjOj757D65SthJuqoikhDcf/VtT1+cRRc+aG4Ii6\n1WlbLNxPWuyJA84r5ws5AJsUH4+KZRbwK4WNhFPOdU3qpaFf/A86XaQEGKS76SCl\ng35OR85yCQKBgQCMTpIlFefoip6fZkhdSu4woCrDdr+zF4zmXUGZaNf9RA5j4gmU\nxKJ60M4HCmyYgoeFB7HXNjjQc+De04Mubtx3th3sDjG2d6BLnMCNrEWYNRzSh++B\nW04pq1+gyVbMSR+M0kB7K2/E9Z2GDmJ7dFXjjSTcdqKIzFTcVH/xwLeCnQKBgQDQ\nfMyLNlZo+CWUA9u42vgrwnAHhJlp3cCRN1oOB7rY8alyBQd9oWN0GO/LlDHL42Iz\nVxQBglHWO0f95JGEyxhjeRdik83R9ooX6IYYyPr+qZJJwqMdQ8hTBYLBrLm1sGy3\nCVGznFpUzHa0acOyMH+En2wJiMORuVcOhDE46aE6AQKBgA3Ah2KCTKJo80i5AqTZ\nkUqJhVzKUzJ31FF5z0xgoplfx/oFG9r4b1DbC4uwDBiNW/E8QGNCoqdllawvTPlw\nzeYio/ApGKvK+UlxYnoENuGdYGxO5nTg+PrO0coWZXJ0hP0M9LYizwt0NSu9pmvO\nY2EjRvJYhaDwf9Npk8LVd7tX\n-----END PRIVATE KEY-----\n",
    "client_email": "fedbakcs-alekseeva@feedbacks-471412.iam.gserviceaccount.com",
    "client_id": "102342325879328211861",
    "auth_uri": "https://accounts.google.com/o/oauth2/auth",
    "token_uri": "https://oauth2.googleapis.com/token",
    "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
    "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/fedbakcs-alekseeva%40feedbacks-471412.iam.gserviceaccount.com",
    "universe_domain": "googleapis.com"
}
GOOGLE_SHEET_NAME = "Wildberries_Feedbacks"  # ‚Üê –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

# --- 1. –ü–æ–ª—É—á–∞–µ–º –í–°–ï –æ—Ç–∑—ã–≤—ã ---
def get_all_feedbacks():
    print("üîç –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –æ—Ç–∑—ã–≤—ã...")
    headers = {"Authorization": WILDBERRIES_FEEDBACK_TOKEN}
    feedbacks = []
    skip = 0

    while True:
        params = {"take": 100, "skip": skip, "order": "dateDesc"}
        try:
            response = requests.get(FEEDBACK_API, headers=headers, params=params)
            if response.status_code != 200:
                print(f"‚ùå –û—à–∏–±–∫–∞ API: {response.status_code}")
                print("–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:", response.text)
                break

            batch = response.json().get("feedbacks", [])
            if not batch:
                break

            feedbacks.extend(batch)

            if len(batch) < 100:
                break
            skip += 100

        except Exception as e:
            print("‚ùå –û—à–∏–±–∫–∞:", str(e))
            break

    print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(feedbacks)} –æ—Ç–∑—ã–≤–æ–≤")
    return feedbacks

# --- 2. –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ ---
def get_product_names(articles):
    if not articles:
        return {}

    print(f"üìå –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è {len(articles)} —Ç–æ–≤–∞—Ä–æ–≤...")
    headers = {"Authorization": WILDBERRIES_CARDS_TOKEN}
    payload = {
        "query": {
            "limit": 100,
            "filters": [
                {
                    "column": "supplierArticle",
                    "filter": articles,
                    "operator": "IN"
                }
            ]
        }
    }

    try:
        response = requests.post(CARDS_API, json=payload, headers=headers)
        if response.status_code != 200:
            print("‚ùå –û—à–∏–±–∫–∞ API –∫–∞—Ä—Ç–æ—á–µ–∫:", response.text)
            return {art: "–û—à–∏–±–∫–∞" for art in articles}

        cards = response.json().get("cards", [])
        return {
            card["supplierArticle"]: card.get("title", "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")
            for card in cards
        }
    except Exception as e:
        print("‚ùå –û—à–∏–±–∫–∞:", str(e))
        return {art: "–û—à–∏–±–∫–∞" for art in articles}

# --- 3. –ê–Ω–∞–ª–∏–∑: –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É ‚Äî 5 —Å–≤–µ–∂–∏—Ö –æ—Ç–∑—ã–≤–æ–≤, —Ñ–∏–ª—å—Ç—Ä <5 ---
def analyze_per_product_last_5(feedbacks, article_to_name):
    print("üìä –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º: 5 —Å–≤–µ–∂–∏—Ö –æ—Ç–∑—ã–≤–æ–≤ –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É...")
    from collections import defaultdict

    grouped = defaultdict(list)
    for fb in feedbacks:
        grouped[fb["supplierArticle"]].append(fb)

    result = []

    for article, fbs in grouped.items():
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ: —Å–≤–µ–∂–∏–µ —Å–Ω–∞—á–∞–ª–∞
        sorted_fbs = sorted(fbs, key=lambda x: x["createdDate"], reverse=True)
        last_5 = sorted_fbs[:5]  # —Ç–æ–ª—å–∫–æ 5 —Å–∞–º—ã—Ö —Å–≤–µ–∂–∏—Ö

        for idx, fb in enumerate(last_5, 1):  # idx = 1, 2, 3, 4, 5
            if fb.get("productValuation") < 5:
                result.append({
                    "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞": article_to_name.get(article, "–ù–µ –Ω–∞–π–¥–µ–Ω–æ"),
                    "–ê—Ä—Ç–∏–∫—É–ª": article,
                    "–ù–æ–º–µ—Ä –æ—Ç–∑—ã–≤–∞ (–≤–Ω—É—Ç—Ä–∏ —Ç–æ–≤–∞—Ä–∞)": idx,  # 1 = —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π
                    "–î–∞—Ç–∞ –æ—Ç–∑—ã–≤–∞": fb["createdDate"][:10],
                    "–û—Ü–µ–Ω–∫–∞": fb["productValuation"],
                    "–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞": fb.get("text", "‚Äî")
                })

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ –¥–∞—Ç–µ: —Å–≤–µ–∂–∏–µ —Å–≤–µ—Ä—Ö—É
    result.sort(key=lambda x: x["–î–∞—Ç–∞ –æ—Ç–∑—ã–≤–∞"], reverse=True)

    print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(result)} –æ—Ç–∑—ã–≤–æ–≤ —Å –æ—Ü–µ–Ω–∫–æ–π <5 (–ø–æ 5 –Ω–∞ —Ç–æ–≤–∞—Ä)")
    return result

# --- 4. –°–æ–∑–¥–∞—ë–º Excel ---
def create_excel(data):
    if not data:
        print("üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á—ë—Ç–∞")
        return None

    filename = f"WB_–Ω–∏–∑–∫–∏–µ_–≤_–ø–æ—Å–ª–µ–¥–Ω–∏—Ö_5_—Å_–Ω–æ–º–µ—Ä–∞–º–∏_{datetime.now().strftime('%d%m%Y')}.xlsx"
    df = pd.DataFrame(data)
    df.to_excel(filename, index=False)
    print(f"‚úÖ –§–∞–π–ª —Å–æ–∑–¥–∞–Ω: {filename}")
    return filename

# --- 5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Google –¢–∞–±–ª–∏—Ü—É ---
def save_to_google_sheets(data):
    print("üì§ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Google –¢–∞–±–ª–∏—Ü—É...")
    try:
        scopes = ["https://www.googleapis.com/auth/spreadsheets"]
        credentials = Credentials.from_service_account_info(SERVICE_ACCOUNT_INFO, scopes=scopes)
        client = gspread.authorize(credentials)
        sheet = client.open(GOOGLE_SHEET_NAME).sheet1
        sheet.clear()
        # –ó–∞–≥–æ–ª–æ–≤–∫–∏
        sheet.append_row([
            "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞", "–ê—Ä—Ç–∏–∫—É–ª", "–ù–æ–º–µ—Ä –æ—Ç–∑—ã–≤–∞", 
            "–î–∞—Ç–∞ –æ—Ç–∑—ã–≤–∞", "–û—Ü–µ–Ω–∫–∞", "–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞"
        ])
        # –î–∞–Ω–Ω—ã–µ
        for row in data:
            sheet.append_row([
                row["–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"],
                row["–ê—Ä—Ç–∏–∫—É–ª"],
                row["–ù–æ–º–µ—Ä –æ—Ç–∑—ã–≤–∞ (–≤–Ω—É—Ç—Ä–∏ —Ç–æ–≤–∞—Ä–∞)"],
                row["–î–∞—Ç–∞ –æ—Ç–∑—ã–≤–∞"],
                str(row["–û—Ü–µ–Ω–∫–∞"]),
                row["–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞"]
            ])
        print(f"‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Google –¢–∞–±–ª–∏—Ü—É: {GOOGLE_SHEET_NAME}")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ Google Sheets: {str(e)}")

# --- 6. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram ---
async def send_to_telegram(filename, count):
    bot = Bot(token=TELEGRAM_BOT_TOKEN)
    if count == 0:
        message = "üü¢ –í –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 –æ—Ç–∑—ã–≤–∞—Ö –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ü–µ–Ω–∫–∏ 5 ‚≠ê"
    else:
        message = f"‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ {count} –æ—Ç–∑—ã–≤–æ–≤ —Å –æ—Ü–µ–Ω–∫–æ–π <5 —Å—Ä–µ–¥–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 –æ—Ç–∑—ã–≤–æ–≤ –ø–æ —Ç–æ–≤–∞—Ä–∞–º"

    try:
        await bot.send_message(chat_id=TELEGRAM_CHAT_ID, text=message)
        if filename:
            await bot.send_document(chat_id=TELEGRAM_CHAT_ID, document=open(filename, "rb"))
        print("‚úÖ –û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!")
    except Exception as e:
        print("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", str(e))

# === üöÄ –ó–ê–ü–£–°–ö ===
def main():
    print(f"üìÖ –ó–∞–ø—É—Å–∫: {datetime.now().strftime('%d.%m.%Y %H:%M')}")

    # 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –æ—Ç–∑—ã–≤—ã
    all_feedbacks = get_all_feedbacks()
    if not all_feedbacks:
        asyncio.run(send_to_telegram(None, 0))
        return

    # 2. –í—Å–µ –∞—Ä—Ç–∏–∫—É–ª—ã
    articles = list({fb["supplierArticle"] for fb in all_feedbacks})

    # 3. –ù–∞–∑–≤–∞–Ω–∏—è
    article_to_name = get_product_names(articles)

    # 4. –ê–Ω–∞–ª–∏–∑: –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –æ—Ç–∑—ã–≤–æ–≤
    report_data = analyze_per_product_last_5(all_feedbacks, article_to_name)

    # 5. Excel
    filename = create_excel(report_data)

    # 6. Google –¢–∞–±–ª–∏—Ü–∞
    save_to_google_sheets(report_data)

    # 7. –û—Ç–ø—Ä–∞–≤–∫–∞
    asyncio.run(send_to_telegram(filename, len(report_data)))

if __name__ == "__main__":
    main()
